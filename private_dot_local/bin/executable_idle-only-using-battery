#!/bin/bash

set -e

function update_idle_delay() {
        status="$1"

	if [ "$status" == "true" ]; then
		gsettings set org.gnome.desktop.session idle-delay 120
	else
		gsettings set org.gnome.desktop.session idle-delay 0
	fi
}

BUSCTL=${BUSCTL:=busctl}

update_idle_delay $(${BUSCTL} get-property --json=short \
        org.freedesktop.UPower \
        /org/freedesktop/UPower \
        org.freedesktop.UPower \
        OnBattery |
        jq --unbuffered ".data")

match="\
type='signal',\
sender='org.freedesktop.UPower',\
interface='org.freedesktop.DBus.Properties',\
member='PropertiesChanged',\
path='/org/freedesktop/UPower',\
arg0='org.freedesktop.UPower'\
"

${BUSCTL} monitor --match="$match" --json=short |
	jq ".payload.data[1].OnBattery.data" --unbuffered |
	while IFS= read -r status; do
                update_idle_delay "$status"
	done
