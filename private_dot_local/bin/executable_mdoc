#!/usr/bin/env bash
# NOTE:
# Use /usr/bin/env to find shell interpreter for better portability.
# Reference: https://en.wikipedia.org/wiki/Shebang_%28Unix%29#Portability

# NOTE:
# Exit immediately if any commands (even in pipeline)
# exits with a non-zero status.
set -e
set -o pipefail

input="${1:-index.md}"
output="$(
	grep \# -m 1 "$input" |
		awk '{$1 = ""; print substr($0, 2)}'
)".pdf

podman run -it --rm \
	-v "$PWD:/data" \
	-v "/usr/share/fonts/:/pandocx/share/fonts" \
	-v "$HOME/.local/share/pandoc/templates:/pandocx/share/pandoc/templates" \
	docker.io/blackdesk/pandocx:with_plantuml \
	"$input" -o "$output" -t typst \
	--columns=80 \
	--extract-media=media \
	--metadata-file="${input%.md}".meta.yaml \
	-M date="$(date)" \
	--from markdown+east_asian_line_breaks \
	--shift-heading-level-by=-1 \
	--lua-filter include-files.lua \
	--lua-filter include-code-files.lua \
	--lua-filter diagram.lua

if command -v xdg-open &>/dev/null; then
	xdg-open "$output" || true
fi
