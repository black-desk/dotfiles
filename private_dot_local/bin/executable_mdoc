#!/usr/bin/env bash
# NOTE:
# Use /usr/bin/env to find shell interpreter for better portability.
# Reference: https://en.wikipedia.org/wiki/Shebang_%28Unix%29#Portability

# NOTE:
# Exit immediately if any commands (even in pipeline)
# exits with a non-zero status.
set -e
set -o pipefail

input="${1:-index.md}"

metadata="${input%.md}".meta.yaml
if [ ! -f "$metadata" ]; then
	metadata="/dev/null"
fi

output="$(
	grep \# -m 1 "$input" |
		awk '{$1 = ""; print substr($0, 2)}'
)".pdf

podman run -it --rm \
	-v "$PWD:/data" \
	-v "/usr/share/fonts/:/usr/share/fonts" \
	docker.io/blackdesk/pandocx:diagram \
	"$input" -o "$output" -t typst \
	--data-dir=/usr/local/share/pandoc \
	--template=PandocX.typst \
	--columns=80 \
	--extract-media=media \
	--metadata-file="$metadata" \
	-M date="$(date)" \
	--from markdown+east_asian_line_breaks \
	--shift-heading-level-by=-1 \
	--lua-filter include-files.lua \
	--lua-filter include-code-files.lua \
	--lua-filter diagram.lua

if command -v xdg-open &>/dev/null; then
	xdg-open "$output" || true
fi
