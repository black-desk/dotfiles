#!/bin/env bash

export LANG=zh_CN.UTF-8
export LANGUAGE=zh_CN:en_US

export VISUAL=nvim
export EDITOR=nvim
export PAGER="less -r"

export HISTFILE="$HOME/.zsh_history"
export SAVEHIST=100000
export HISTSIZE=100000

function update_path() {
        local dir=$1
        local append=$2
        if [[ ${path[(ie)$dir]} -gt ${#path} ]]; then 
                if [[ -n $append ]]; then
                        path+=($dir)
                else
                        path=($dir $path)
                fi
        fi
}

update_path "$HOME/.local/bin"
update_path "/sbin" append
update_path "/bin" append
update_path "/usr/sbin" append
update_path "/usr/bin" append
update_path "/usr/local/sbin" append
update_path "/usr/local/bin" append

# GOENV

export GOENV_ROOT="$HOME/.goenv"
export GOENV_HOOK_PATH="$HOME/.local/lib/goenv_hook/"
export GOENV_APPEND_GOPATH=
export GOENV_PREPEND_GOPATH=1
export GOPATH="$HOME/Documents/go"
export GOENV_GOPATH_PREFIX="$GOPATH"

update_path "$GOPATH/bin"
update_path "$GOENV_ROOT/bin"
update_path "$GOENV_ROOT/shims"

goenv(){
        unset -f goenv
        eval "$(goenv init -)"
        goenv $@
}

(( $+commands[go] )) || goenv install latest
(( $+commands[chezmoi] )) || go install github.com/twpayne/chezmoi@latest
(( $+commands[chezmoi] )) || go install github.com/twpayne/chezmoi@latest
(( $+commands[croba-cli] )) || go install github.com/spf13/cobra-cli@latest
(( $+commands[dlv] )) || go install github.com/go-delve/delve/cmd/dlv@latest
(( $+commands[gh] )) || go install github.com/cli/cli@latest
(( $+commands[lazygit] )) || go install github.com/jesseduffield/lazygit@latest
(( $+commands[stringer] )) || go install golang.org/x/tools/cmd/stringer@latest

# pyenv

export PYENV_ROOT="$HOME/.pyenv"
export PYENV_HOOK_PATH="$HOME/.local/lib/pyenv_hook/"

update_path "$PYENV_ROOT/bin"
update_path "$PYENV_ROOT/shims"

pyenv(){
        unset -f pyenv
        eval "$(pyenv init -)"
        pyenv $@
}

command -v python &>/dev/null || (
        pyenv install 3.10
        pyenv install miniconda3
        pyenv global 3.10
)

# n

export N_PREFIX="$HOME/.n"

update_path "$N_PREFIX/bin"

[ -s "$N_PREFIX/bin/n" ] || (
        echo "Setting up n" &&
        curl -L https://bit.ly/n-install | \
                N_PREFIX=~/.n \
                N_INSTALL_TEST_OVERRIDE_SKIP_EXISTING_INSTALLATION_TEST=1 \
                bash /dev/stdin -n -y
)

# ghcup
update_path "$HOME/.ghcup/bin"

# rustup
cargo &> /dev/null || rustup install nightly

[ ! -f "$HOME/.cargo/env" ] || . "$HOME/.cargo/env"

unset update_path
